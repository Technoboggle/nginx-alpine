fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=CACHEZONE:10m inactive=60m max_size=40m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
add_header X-Cache $upstream_cache_status;#

server {
   listen       80;
   server_name  localhost;
   server_name  augustine.technoboggle.net;

   root   /usr/share/nginx/html;
   index  index.html index.htm;

   security_headers on;
   hide_server_tokens on;
   server_tokens off;
   
   charset utf-8;
   source_charset utf-8;
#   access_log off;
#   error_log  stderr error;
   access_log  /usr/parent/shared/logs/host.access.log main;
   error_log   /usr/parent/shared/logs/host.error.log  debug;

   # I'm being fairly generous max_body_size and very generous client_boidy_timeout.
   # I highly recommend you configure PHP with lower values.
   client_max_body_size 200m;
   client_body_timeout 600s;

   sendfile on;

   # 2 text/html
   gzip on;
   gzip_vary on;
   gzip_min_length 10240;
   gzip_proxied expired no-cache no-store private auth;
   gzip_types font/eot font/ttf font/woff font/woff2 text/plain text/css text/xml text/javascript application/javascript application/octet-stream application/x-javascript application/xml;
   gzip_disable "MSIE [1-6]\.";
   gunzip on;

   location = /favicon.ico { access_log off; log_not_found off; }
   location = /robots.txt  { access_log off; log_not_found off; }

   location / {

      if (!-f $document_root$fastcgi_script_name) {
         # nginx requires access to the PHP files to check this
         return 404;
      }
   }

   # Make nginx serve the challenge files from certbot! 
   location /.well-known/acme-challenge/ {
      root /usr/share/nginx/certbot;
   }

   #error_page  404              /404.html;

   # redirect server error pages to the static page /50x.html
   #
   error_page   500 502 503 504  /50x.html;
   location = /50x.html {
      root   /usr/share/nginx/html;
   }

   # proxy the PHP scripts to Apache listening on 127.0.0.1:80
   #
   #location ~ \.php$ {
   #    proxy_pass   http://127.0.0.1;
   #}

   # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
   #
   location ~ \.php$ {
      #root           html;
      try_files $uri =404;
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      fastcgi_pass   php:9000;
      fastcgi_index  index.php;
      fastcgi_param  SCRIPT_FILENAME  $document_root/scripts$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
      include        fastcgi_params;
      fastcgi_cache CACHEZONE;
      fastcgi_cache_min_uses 3;
      fastcgi_cache_valid 200  301 203 60m;
      fastcgi_cache_valid 404 10m;
      fastcgi_cache_revalidate on;
      proxy_cache_use_stale error timeout http_500;
      fastcgi_cache_background_update on;
      fastcgi_cache_lock on;

      # Mitigate https://httpoxy.org/ vulnerabilities
      fastcgi_param HTTP_PROXY "";
      fastcgi_intercept_errors off;
      fastcgi_connect_timeout 30s;
      fastcgi_send_timeout 300s;
      fastcgi_read_timeout 600s;

      # Removing the leading slash from $fastcgi_script_name allows it to be interpreted relative to php-fpm.conf's `chdir` directive
      set $filename "index.php";
      if ( $fastcgi_script_name ~ "^/+(.*)$" ) {
         set $filename $1;
      }
      fastcgi_param SCRIPT_FILENAME $filename;
      fastcgi_param PATH_INFO       $fastcgi_path_info;
      fastcgi_param PATH_TRANSLATED $fastcgi_path_info;
   }

   # deny access to .htaccess files, if Apache's document root
   # concurs with nginx's one
   #
   location ~ /\.ht {
      deny  all;
   }

   # simplest example of a publisher location for nchan
   location ~ /pub$ {
      nchan_publisher;
      nchan_channel_id $arg_id;
   }

   # simplest exmapl of a subscriber location for nchan
   location ~ /sub$ {
      nchan_subscriber;
      nchan_channel_id $arg_id;
   }

   location ~ /channel_events$ {
      #channel events subscriber location
      #nchan_subscriber;
      #nchan_channel_group meta; #"meta" is a SPECIAL channel group
      #nchan_channel_id $1;
      nchan_stub_status;
   }

      #   location ~* .(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|css|rss|atom|js|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
      ##      expires 365d;
      #      expires max;
      #      log_not_found off;
      #      access_log off;
      #   }

}

